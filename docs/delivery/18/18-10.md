# [18-10] Test Claude Desktop integration

[Back to task list](./tasks.md)

## Description

Verify complete end-to-end compatibility between the MCP-compliant CODAP server and Claude Desktop, implementing streamlined connection UX for nontechnical users in constrained environments. Test the full workflow from CODAP plugin setup through natural language CODAP manipulation via Claude Desktop.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-21 14:00:00 | Created | N/A | Proposed | Task file created with streamlined UX approach | AI_Agent |
| 2025-01-21 16:30:00 | Status Update | Proposed | InProgress | Phase 1 UI implementation completed, starting Phase 2 testing | AI_Agent |
| 2025-01-21 17:30:00 | Status Update | InProgress | Review | All implementation phases completed, comprehensive testing suite created, ready for User validation | AI_Agent |

## Requirements

### **Core Integration Testing**
1. **MCP Server Compatibility**: Verify Claude Desktop successfully connects to our MCP endpoint
2. **Tool Discovery**: Confirm all 33 CODAP tools are discoverable via Claude Desktop
3. **Tool Execution**: Test both browser worker and direct execution modes
4. **Session Management**: Validate session-based tool isolation and management
5. **Error Handling**: Verify proper error messages and recovery workflows

### **Streamlined UX Implementation**
1. **Two-Phase UI Design**: Implement separate setup vs. regular connection workflows
2. **Prominent Session Display**: Clear, prominent session ID with copy functionality
3. **Hidden Setup Link**: Unobtrusive "Set up Claude MCP" link for initial configuration
4. **Connection Instructions**: Complete copy-paste instructions for Claude Desktop
5. **Real-time Status**: Live connection status updates and feedback

### **End-to-End Workflow Validation**
1. **CODAP Plugin Setup**: Load plugin in CODAP with new streamlined UI
2. **Claude Desktop Configuration**: Test one-time MCP server setup process
3. **Session Connection**: Verify session-based connection establishment
4. **Natural Language Operations**: Test comprehensive CODAP manipulation via Claude
5. **Error Scenarios**: Test connection failures, timeouts, and recovery

## Implementation Plan

### **Phase 1: Enhanced Plugin UI (2 hours)**

**Streamlined Connection Interface:**
```typescript
// Enhanced PairingBanner component
interface StreamlinedConnectionProps {
  sessionId: string;
  connectionStatus: 'waiting' | 'connected' | 'error';
  onCopyInstructions: () => void;
  onShowSetup: () => void;
}

function StreamlinedConnectionUI({ sessionId, connectionStatus, onCopyInstructions, onShowSetup }: StreamlinedConnectionProps) {
  return (
    <div className="codap-ai-assistant">
      <div className="header">
        <h2>ðŸ¤– CODAP AI Assistant</h2>
      </div>
      
      <div className="session-section">
        <div className="session-display">
          <span className="session-label">Session:</span>
          <span className="session-id">{sessionId}</span>
        </div>
        <button 
          className="copy-instructions-btn primary"
          onClick={onCopyInstructions}
        >
          ðŸ“‹ Copy Claude Connection Instructions
        </button>
      </div>
      
      <div className="status-section">
        <ConnectionStatus status={connectionStatus} />
      </div>
      
      <div className="help-section">
        <a 
          href="#" 
          className="setup-link subtle"
          onClick={onShowSetup}
        >
          Need help? Set up Claude MCP â†—
        </a>
      </div>
    </div>
  );
}
```

**Setup Modal Implementation:**
```typescript
function ClaudeSetupModal({ sessionId, isOpen, onClose }: SetupModalProps) {
  const claudeConfig = {
    "mcpServers": {
      [`codap-session-${sessionId}`]: {
        "command": "npx",
        "args": [
          "@modelcontextprotocol/server-fetch",
          "https://codap-aqzdjk77d-cdorsey-concordorgs-projects.vercel.app/api/mcp"
        ],
        "env": {
          "MCP_SESSION_ID": sessionId
        }
      }
    }
  };

  return (
    <Modal isOpen={isOpen} onClose={onClose}>
      <div className="setup-modal">
        <h3>Set up Claude Desktop MCP</h3>
        <div className="config-section">
          <p>Add this configuration to your Claude Desktop config file:</p>
          <pre className="config-block">
            {JSON.stringify(claudeConfig, null, 2)}
          </pre>
          <button onClick={() => copyToClipboard(JSON.stringify(claudeConfig, null, 2))}>
            ðŸ“‹ Copy Configuration
          </button>
        </div>
        <div className="instructions">
          <h4>Configuration File Location:</h4>
          <ul>
            <li><strong>macOS:</strong> <code>~/.config/claude-desktop/claude_desktop_config.json</code></li>
            <li><strong>Windows:</strong> <code>%APPDATA%\Claude\claude_desktop_config.json</code></li>
            <li><strong>Linux:</strong> <code>~/.config/claude-desktop/claude_desktop_config.json</code></li>
          </ul>
          <p><strong>After adding configuration:</strong> Restart Claude Desktop</p>
        </div>
      </div>
    </Modal>
  );
}
```

**Connection Instructions Generator:**
```typescript
function generateConnectionInstructions(sessionId: string): string {
  return `Connect to CODAP session ${sessionId}

Tell Claude: "Connect to CODAP session ${sessionId}"

This will connect Claude to your current CODAP workspace so you can:
â€¢ Create and modify datasets
â€¢ Generate graphs and visualizations  
â€¢ Filter and analyze data
â€¢ Perform calculations and statistics

Need help setting up Claude Desktop? Click "Set up Claude MCP" in the plugin.`;
}
```

### **Phase 2: Claude Desktop Testing (2 hours)**

**Test Environment Setup:**
1. Install Claude Desktop on testing machine
2. Configure MCP server connection using generated configuration
3. Verify MCP server appears in Claude Desktop's available tools
4. Test basic connectivity and tool discovery

**Comprehensive Tool Testing:**
```javascript
// Test script for comprehensive CODAP tool validation
const testScenarios = [
  {
    name: "Basic Data Creation",
    instruction: "Create a new dataset called 'Students' with columns Name, Age, Grade, and Score",
    expectedTools: ["createDataContext", "createCollection"],
    validation: "Dataset appears in CODAP with correct structure"
  },
  {
    name: "Data Population",
    instruction: "Add 5 sample student records to the Students dataset",
    expectedTools: ["createItems"],
    validation: "5 records appear in CODAP table"
  },
  {
    name: "Visualization Creation",
    instruction: "Create a scatter plot showing the relationship between Age and Score",
    expectedTools: ["createComponent", "selectCases"],
    validation: "Scatter plot appears with correct axes"
  },
  {
    name: "Data Analysis",
    instruction: "Calculate the average score for all students",
    expectedTools: ["getCases", "updateComponent"],
    validation: "Average calculation displayed correctly"
  },
  {
    name: "Data Filtering",
    instruction: "Show only students with scores above 85",
    expectedTools: ["selectCases", "createFilter"],
    validation: "Table filters to show only high-scoring students"
  }
];
```

### **Phase 3: Error Handling and Edge Cases (1 hour)**

**Error Scenario Testing:**
1. **Session Timeout**: Test behavior when session expires during use
2. **Connection Loss**: Test recovery when network connection drops
3. **Invalid Commands**: Test error handling for malformed requests
4. **Tool Failures**: Test error reporting when CODAP operations fail
5. **Concurrent Sessions**: Test multiple CODAP sessions with different Claude instances

### **Phase 4: Performance and Usability Testing (1 hour)**

**Performance Metrics:**
- Tool discovery time (should be <2 seconds)
- Tool execution latency (should be <5 seconds for simple operations)
- Session connection time (should be <3 seconds)
- UI responsiveness during operations

**Usability Testing:**
- Time for new user to complete full setup (target: <5 minutes)
- Clarity of connection instructions
- Effectiveness of error messages
- Intuitiveness of natural language commands

## Verification

### **Technical Integration Tests**
- [ ] Claude Desktop successfully connects to MCP server
- [ ] All 33 CODAP tools discoverable via `list_tools`
- [ ] Tool execution works in both browser worker and direct modes
- [ ] Session isolation prevents cross-session interference
- [ ] Error handling provides clear, actionable messages
- [ ] Connection recovery works after network interruption

### **UX Implementation Tests**
- [ ] Streamlined UI displays session prominently
- [ ] "Copy Claude Connection Instructions" button works correctly
- [ ] Instructions copied include complete connection text
- [ ] "Set up Claude MCP" link shows configuration modal
- [ ] Configuration JSON is valid and properly formatted
- [ ] Real-time status updates work correctly

### **End-to-End Workflow Tests**
- [ ] Complete workflow from CODAP load to Claude connection takes <5 minutes
- [ ] Natural language CODAP operations work seamlessly
- [ ] Data appears in CODAP in real-time as Claude executes commands
- [ ] Complex multi-step operations (create dataset â†’ add data â†’ make graph) work
- [ ] Error scenarios provide helpful recovery guidance

### **Compatibility Tests**
- [ ] Works on macOS Claude Desktop
- [ ] Works on Windows Claude Desktop  
- [ ] Works on Linux Claude Desktop
- [ ] Compatible with latest Claude Desktop version
- [ ] Configuration survives Claude Desktop restarts

## Test Plan

### **Test Environment Setup**
1. **CODAP Instance**: Load CODAP at https://codap.concord.org/app/
2. **Plugin Loading**: Add CODAP-MCP plugin via current production URL
3. **Claude Desktop**: Install and configure on test machine
4. **Network Conditions**: Test on various network conditions (fast, slow, intermittent)

### **Test Scenarios**

**Scenario 1: First-Time User Setup**
1. User loads CODAP with plugin (fresh state)
2. User sees streamlined connection UI
3. User clicks "Set up Claude MCP" link
4. User copies configuration and adds to Claude Desktop
5. User restarts Claude Desktop
6. User copies connection instructions from plugin
7. User pastes instructions into Claude Desktop
8. Verify successful connection and tool availability

**Scenario 2: Returning User Connection**
1. User loads CODAP with plugin (Claude already configured)
2. User copies connection instructions
3. User pastes into Claude Desktop
4. Verify immediate connection without setup steps

**Scenario 3: Comprehensive CODAP Operations**
1. User connects Claude to CODAP session
2. User requests: "Create a dataset for tracking student performance"
3. User requests: "Add sample data with names, grades, and test scores"
4. User requests: "Create a bar chart showing grade distribution"
5. User requests: "Calculate the average test score"
6. User requests: "Filter to show only students with A grades"
7. Verify all operations complete successfully in CODAP

**Scenario 4: Error Recovery**
1. User connects Claude to CODAP session
2. Simulate session timeout
3. User attempts operation
4. Verify clear error message and recovery instructions
5. User reconnects and continues working

**Scenario 5: Multiple Sessions**
1. User opens multiple CODAP tabs with different datasets
2. User connects Claude to each session separately
3. Verify operations in one session don't affect others
4. Test switching between sessions in Claude

### **Success Criteria**
- **Setup Time**: New user completes full setup in <5 minutes
- **Connection Time**: Returning user connects in <30 seconds
- **Operation Latency**: Simple operations complete in <5 seconds
- **Error Recovery**: Clear error messages with actionable recovery steps
- **Tool Coverage**: All 33 CODAP tools accessible and functional
- **Session Isolation**: Multiple sessions work independently

## Files Modified

### **Frontend Updates**
- `src/components/PairingBanner.tsx` - Implement streamlined connection UI
- `src/components/ClaudeSetupModal.tsx` - New setup modal component
- `src/components/ConnectionStatus.tsx` - Enhanced status display
- `src/utils/claudeInstructions.ts` - Connection instructions generator
- `src/styles/claude-integration.css` - Styling for new UI components

### **Testing Files**
- `test-claude-desktop-integration.js` - Comprehensive integration test suite
- `test-claude-setup-ui.js` - UI component testing
- `test-claude-connection-flow.js` - End-to-end workflow testing

## Dependencies

- **Task 18-7**: Complete MCP protocol compliance (completed)
- **Claude Desktop**: Installed and accessible for testing
- **Production MCP Server**: Current deployment at `https://codap-aqzdjk77d-cdorsey-concordorgs-projects.vercel.app/api/mcp`
- **CODAP Access**: https://codap.concord.org/app/ for testing

## Implementation Notes

### **Design Philosophy**
This task implements a **nontechnical user-first** approach that separates one-time setup from regular usage. The design assumes users:
- Cannot install browser extensions or run local servers
- Need clear, copy-paste instructions without technical jargon
- Want immediate feedback on connection status
- Prefer visual confirmation of successful operations

### **Technical Approach**
- **Additive Implementation**: New UI components alongside existing functionality
- **Progressive Enhancement**: Enhanced UX without breaking existing workflows  
- **Graceful Degradation**: Fallback to manual session codes if needed
- **Real-time Feedback**: Live status updates and immediate confirmation

### **Testing Strategy**
- **Real-world Conditions**: Test on actual Claude Desktop installations
- **User Journey Focus**: Test complete workflows, not just individual features
- **Error Path Coverage**: Comprehensive testing of failure scenarios
- **Performance Validation**: Ensure acceptable response times for all operations

This task represents the culmination of PBI 18's MCP compliance work, providing real-world validation that our MCP server works seamlessly with the primary target client (Claude Desktop) while delivering an excellent user experience for nontechnical users. 