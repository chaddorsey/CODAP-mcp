# 22-5 Implement Direct Message Relay for SageAPI Tester â†” SageModeler Plugin

[Back to task list](./tasks.md)

## Description
Implement a direct, transparent postMessage relay channel in the main plugin (AppDualMode.tsx) between the embedded SageAPI tester iframe and the SageModeler plugin iframe. This relay should mimic the original reference plugin's expectations: all API requests from the tester are forwarded as-is to the SageModeler iframe, and all responses/events from SageModeler are relayed back to the tester. No message transformation or wrapping should occur. This enables robust, integration-accurate testing and ensures the tester UI and SageModeler remain in sync.

**Key requirements:**
- All API requests from the tester iframe are relayed directly to the SageModeler plugin iframe (not just CODAP)
- All responses/events from the SageModeler plugin iframe are relayed back to the tester iframe
- The relay logic is centralized and DRY in AppDualMode.tsx
- Request/response matching is preserved (requestId is not altered)
- Security: For now, use '*' for postMessage, but document the need for origin checks in production
- No message wrapping or transformation; relay objects as-is
- Future extensibility: design relay logic to allow toggling between direct and browser worker paths if needed

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-20 10:00:00 | Created | N/A | InProgress | Task file created and work started | AI_Agent |
| 2025-01-20 10:30:00 | Implementation | InProgress | Review | Message relay logic implemented in AppDualMode.tsx. However, discovered root cause: server name "codap-mcp" causing Claude Desktop to prefix SageModeler tools | AI_Agent |
| 2025-01-20 10:35:00 | Root Cause Fix | Review | Done | Fixed server name prefix issue by setting serverInfo.name to empty string in mcp.js initialize, capabilities, and health check endpoints. This prevents Claude Desktop from adding "CODAP MCP Server:" prefix to tool calls | AI_Agent |
| 2025-01-20 11:00:00 | Refinement | Done | InProgress | Task refined to require two-way relay between SageAPI tester and SageModeler plugin iframes, including requests, responses, and events. | AI_Agent |
| 2025-06-10 14:00:00 | Plan Update | InProgress | InProgress | Updated implementation plan to specify direct, transparent relay channel based on original plugin analysis. Added rationale, security, and extensibility notes. | AI_Agent |

## Requirements
- Listen for postMessage events from the SageAPI tester iframe
- Relay all API requests to the SageModeler plugin iframe using postMessage, preserving the message object
- Listen for postMessage events from the SageModeler plugin iframe and relay all responses/events back to the tester iframe
- Do not modify, wrap, or transform messages; preserve requestId and structure
- Centralize all relay logic in AppDualMode.tsx for maintainability
- Document the need for origin checks for production security
- Design for future extensibility (e.g., toggling between direct and browser worker relay)
- Test that actions in the tester result in expected changes in SageModeler and vice versa

## Implementation Plan
1. **Analysis & Design**
   - Review original reference plugin's postMessage expectations and structure
   - Document rationale for direct relay (robustness, integration accuracy, simplicity)
   - Identify all message types to be relayed (requests, responses, events)
2. **Relay Channel Setup**
   - Add refs for both the SageAPI tester and SageModeler plugin iframes in AppDualMode.tsx
   - Add a single window 'message' event listener in AppDualMode.tsx
   - On message from tester iframe: if message is a Sage API request, forward to SageModeler iframe
   - On message from SageModeler iframe: if message is a Sage API response/event, forward to tester iframe
   - Ensure no infinite loops (only relay between the two, not to self)
3. **Request/Response Handling**
   - Preserve requestId and all message fields
   - Do not alter or wrap messages
   - Optionally, log relayed messages for debugging
4. **Security Considerations**
   - For now, use '*' for postMessage; document the need for origin checks in production
   - Add TODO comments for future origin validation
5. **Testing**
   - Confirm that clicking 'Create Random Node' in the tester creates a node in SageModeler
   - Confirm that 'Get All Nodes' and other API actions work and update both UIs
   - Confirm that responses/events are relayed back to the tester and UI updates occur
   - Confirm no infinite relay loops or security issues
6. **Documentation & Extensibility**
   - Document relay logic in code comments
   - Note how to extend for browser worker relay or other integration paths

## Verification
- Confirm that all tester actions (create, get, update, delete nodes/links) are reflected in SageModeler
- Confirm that SageModeler responses/events are relayed back and update the tester UI
- Confirm that requestId and message structure are preserved
- Confirm that all relay logic is centralized and DRY
- Confirm that no security or infinite loop issues occur
- Confirm that relay logic can be extended for future integration paths

## Files Modified
- src/components/AppDualMode.tsx (relay logic)
- docs/delivery/22/tasks.md (this task added)
- docs/delivery/22/22-5.md (this file) 