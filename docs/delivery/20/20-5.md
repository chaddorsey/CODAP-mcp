# 20-5 Enable Dual-Mode Plugin for SageModeler API Direct Testing and LLM Round-Trip E2E

[Back to task list](../20/tasks.md)

## Description
Introduce a new dual-mode plugin architecture to support both LLM-driven E2E testing and direct, developer-facing SageModeler API experimentation. This enables seamless switching between "CODAP mode" (current behavior) and "SageModeler mode" (new, developer/tester-focused mode), with a direct API testing UI that leverages the MCP tool translation layer.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-07-04 17:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements
- Dual-mode plugin with UI switch between CODAP and SageModeler modes
- SageModeler mode exposes a direct API testing UI (from the reference plugin) using the MCP tool translation layer
- All API calls (from LLM or direct UI) are logged in the plugin
- Original CODAP-only plugin remains available and unchanged
- Audit and documentation of plugin extension and parallel track

## Implementation Plan
1. Audit the current plugin extension and document any changes from the original CODAP-only plugin
2. Ensure the original plugin can be reconstituted if needed
3. Establish a parallel track for the new dual-mode plugin
4. Add a mode switch (text link, lower-left) to toggle between CODAP and SageModeler modes
5. In SageModeler mode, change title to "SageModeler + Claude" and add an accordion at the bottom: "Direct SageModeler API tools"
6. Expanding the accordion reveals the reference plugin UI, but all buttons/actions route through the MCP tool translation layer
7. Ensure all direct UI actions and LLM-driven tool calls use the same translation and logging infrastructure
8. Provide clear logs of API requests and responses for both paths

## Verification
- Plugin can switch between CODAP and SageModeler modes via a subtle UI link
- In SageModeler mode, the plugin exposes a direct API testing UI that uses the MCP tool translation layer
- All API calls (from LLM or direct UI) are logged in the plugin
- The original CODAP-only plugin remains available and unchanged
- Audit and documentation of the plugin extension and parallel track are complete

## Files Modified
- docs/delivery/20/20-5.md (this file)
- Plugin source files (to be specified)
- Reference plugin: design/reference/sage-api-plugin.html

## PRD

### Overview
This PBI introduces a new dual-mode plugin architecture to support both LLM-driven E2E testing and direct, developer-facing SageModeler API experimentation. The goal is to:
- Allow seamless switching between "CODAP mode" (current behavior) and "SageModeler mode" (new, developer/tester-focused mode)
- In SageModeler mode, expose a direct API testing UI (from the reference plugin) that leverages the new MCP tool translation layer, not the legacy direct API calls
- Ensure all API calls, whether from LLM or direct UI, are routed through the same translation and logging infrastructure
- Prepare the codebase for future tool-capability filtering and extensibility

### Problem Statement
The current plugin only supports LLM-driven tool calls in a CODAP context. There is no way to directly test or experiment with the new SageModeler API integration, nor to validate the translation layer independently of the LLM. This limits developer velocity and makes debugging more difficult.

### User Stories
- As a developer, I want to directly test SageModeler API tools via the plugin UI, so I can debug and validate the MCP tool translation layer.
- As a tester, I want to switch between CODAP and SageModeler modes, so I can verify both workflows in a single plugin.
- As a developer, I want the direct API testing UI to use the same translation and logging infrastructure as LLM-driven calls, so I can trust that both paths are equivalent.
- As a product owner, I want to maintain the original CODAP-only plugin for reliability, and develop the new dual-mode plugin in parallel.

### Technical Approach
1. **Audit and Comparison**
   - Audit the current plugin extension and document any changes from the original CODAP-only plugin.
   - If it doesn't currently exist, reconstitute the original plugin for reference and independent use.
   - Establish a parallel track and file for the new dual-mode plugin.
2. **Dual-Mode Architecture**
   - Add a mode switch (text link, lower-left) to toggle between "CODAP mode" and "SageModeler mode".
   - In CODAP mode: plugin UI and behavior remain unchanged.
   - In SageModeler mode:
     - Change title to "SageModeler + Claude"
     - Add an accordion at the bottom: "Direct SageModeler API tools"
     - Expanding the accordion reveals the reference plugin UI (from `design/reference/sage-api-plugin.html`), but all buttons/actions route through the plugin's core MCP tool translation layer.
     - All generated API calls and responses are logged in the plugin's log area for developer visibility.
3. **Testing and Logging**
   - Ensure all direct UI actions and LLM-driven tool calls use the same translation and logging infrastructure.
   - Provide clear logs of API requests and responses for both paths.
4. **Parallel Plugin Development**
   - Develop the new dual-mode plugin as a separate file/component, preserving the original CODAP-only plugin for reliability.

### Acceptance Criteria
- The plugin can switch between CODAP and SageModeler modes via a subtle UI link.
- In SageModeler mode, the plugin exposes a direct API testing UI (from the reference plugin) that uses the MCP tool translation layer.
- All API calls (from LLM or direct UI) are logged in the plugin.
- The original CODAP-only plugin remains available and unchanged.
- Audit and documentation of the plugin extension and parallel track are complete.

### Dependencies
- Reference plugin UI: design/reference/sage-api-plugin.html
- MCP tool translation layer (already implemented)
- Existing CODAP plugin and relay infrastructure

### Other Notes
- The mode switch can default to CODAP on reload
- The direct API testing UI should be available in production builds

### Related Tasks
- [Audit SageModeler plugin functions and define schemas]
- [Map each function to SageModeler API calls and define translation logic]
- [Integrate new tools into MCP registry]
- [Implement relay plugin translation functions]
- [Develop E2E tests for SageModeler tool calls] (now 20-6)
- [Update documentation for dual-application support] (now 20-7) 