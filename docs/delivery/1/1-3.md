# 1-3 Implement SSE stream endpoint

[Back to task list](./tasks.md)

## Description
Create `GET /stream` Edge Function that establishes an SSE connection filtered by session `code` query param and pushes tool requests to the browser.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| <!-- TIMESTAMP --> | Created | N/A | Proposed | Task file created | ai-agent |

## Requirements
* Accept `code` query parameter; respond 400 if missing / invalid.
* Use `text/event-stream` with auto-retry header.
* Stream events when new requests arrive in KV list `req::<code>`.
* Heartbeat every 30 s to keep connection alive.
* Fallback polling spec documented in PBI handled by browser (PBI-3).

## Implementation Plan
1. Add route to `vercel.json` for `/stream`.
2. Implement `server/relay/get-stream.ts` using Vercel Edge runtime.
3. Use `kv.lrange` polling inside setInterval.
4. Clean up on `fetchEvent.signal` abort.

## Verification
* Manual dev deploy shows EventSource receiving events.
* Jest integration test simulates request insertion and receives SSE event.

## Files Modified
* `server/relay/get-stream.ts` (new)
* `vercel.json`
* `src/test/relay/stream.test.ts`
