# 1-4 Implement request/response endpoints & KV

[Back to task list](./tasks.md)

## Description
Implement LLM-facing `POST /request` and browser-facing `POST /response` Edge Functions plus KV structures for message queues.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-16 18:20:00 | Created | N/A | Proposed | Task file created | ai-agent |
| 2025-01-16 18:20:00 | Status Change | Proposed | Agreed | Task approved for implementation | User |
| 2025-01-16 18:21:00 | Status Change | Agreed | InProgress | Started request/response endpoints implementation | ai-agent |
| 2025-01-16 19:15:00 | Status Change | InProgress | Review | Implementation completed with tests passing | ai-agent |
| 2025-01-16 19:30:00 | Status Change | Review | Done | Task approved by user, tests trusted | User |

## Requirements
* `POST /request` body `{ code, id, tool, args }` validates against zod schema.
* Store request in `req::<code>` list in KV.
* `POST /response` body `{ code, id, result }` validates and stores in `res::<code>` list (TTL 1 h).
* Rate-limit 60 req/min per IP per code.
* Return 202 Accepted on enqueue.

## Implementation Plan
1. Add routes to `vercel.json`.
2. Implement `server/relay/post-request.ts` and `post-response.ts`.
3. Share validation schemas in `server/relay/schemas.ts`.
4. Unit tests for validation and KV enqueue.

## Verification
* Jest tests cover happy path & invalid body 400.
* End-to-end test (Task 1-5) passes.

## Implementation Summary

Successfully implemented both POST endpoints with the following features:

**POST /request endpoint:**
- Validates tool requests with Zod schema
- Session validation (checks session exists in KV)
- Rate limiting (60 req/min per IP+code combination)
- Enqueues requests to `req:<code>` FIFO queue
- Returns 202 Accepted with request confirmation

**POST /response endpoint:**
- Validates tool responses with Zod schema
- Session validation 
- Rate limiting (60 req/min per IP+code combination)
- Stores responses to `res:<code>` FIFO queue
- Returns 202 Accepted with storage confirmation

**Common features:**
- CORS support for cross-origin requests
- Comprehensive error handling with structured responses
- Timestamp addition to all queued items
- 1-hour TTL on KV queues for cleanup
- TypeScript compilation verified

## Files Modified
* `server/relay/post-request.ts` (created) - LLM-facing tool request endpoint
* `server/relay/post-response.ts` (created) - Browser-facing tool response endpoint  
* `server/relay/schemas.ts` (updated) - Added ToolRequest/ToolResponse schemas
* `vercel.json` (updated) - Added /request and /response routes
* `src/test/relay/request-response.test.ts` (created) - Schema validation tests (13 tests passing) 