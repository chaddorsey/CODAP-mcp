# 1-6 Implement KV storage for session persistence

[Back to task list](./tasks.md)

## Description
Replace the current in-memory demo storage with persistent Vercel KV storage for sessions, tool requests, and tool responses to enable production-scale session management and reliability.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-06-17 01:30:00 | Created | N/A | Proposed | Task file created to complete original PBI 1 scope | AI_Agent |
| 2025-06-17 01:35:00 | Status Change | Proposed | Agreed | Task approved to complete original PBI 1 KV storage requirements | User |

## Requirements
- **Session Storage**: Store session metadata in Vercel KV with automatic TTL (10 minutes)
- **Request Queue**: Use KV for tool request message queuing with FIFO semantics
- **Response Queue**: Use KV for tool response message queuing with TTL (1 hour)
- **SSE Integration**: Update SSE streams to read from KV queues instead of in-memory
- **Migration**: Remove all "Demo version - not persisted" messages
- **Verification**: All existing tests must continue to pass with KV storage

## Implementation Plan
1. **Set up Vercel KV Integration**:
   - Add @vercel/kv dependency (if not already present)
   - Configure KV connection in production environment
   - Add environment variable for KV_URL

2. **Create Storage Abstraction Layer**:
   - Create shared storage utilities in `api/kv-utils.js`
   - Implement session storage functions: `storeSession()`, `getSession()`, `deleteSession()`
   - Implement queue functions: `enqueueRequest()`, `dequeueRequest()`, `enqueueResponse()`, `dequeueResponse()`

3. **Update API Endpoints**:
   - `api/sessions.js`: Store sessions in KV instead of returning demo message
   - `api/request.js`: Queue requests in KV instead of logging only
   - `api/response.js`: Store responses in KV for retrieval by SSE
   - `api/stream.js`: Read from KV queues and deliver messages via SSE

4. **Update Test Infrastructure**:
   - Ensure tests can work with KV storage (mock in test environment)
   - Update test assertions to remove "demo version" checks
   - Verify all existing functionality works with persistent storage

## Verification
- **Functional Tests**: All existing integration tests pass
- **Persistence Tests**: Sessions survive function restarts (simulated)
- **Queue Tests**: Tool requests and responses are reliably queued and delivered
- **SSE Tests**: Messages are delivered from KV storage to browser clients
- **Performance Tests**: No significant latency degradation from KV operations
- **Cleanup Tests**: Expired sessions and messages are properly cleaned up by TTL

## Technical Notes
- **KV Key Patterns**:
  - Sessions: `session:{code}` → `{createdAt, ttl}`
  - Requests: `req:{code}` → List of `{id, tool, args, timestamp}`
  - Responses: `res:{code}` → List of `{id, result, timestamp}`
- **TTL Strategy**:
  - Sessions: 10 minutes (matching current design)
  - Request queues: 1 hour (for cleanup)
  - Response queues: 1 hour (for cleanup)
- **Error Handling**: Graceful fallback behavior if KV is temporarily unavailable

## Files Modified
- `api/sessions.js` (update to use KV storage)
- `api/request.js` (update to queue in KV)
- `api/response.js` (update to store in KV)
- `api/stream.js` (update to read from KV)
- `api/kv-utils.js` (new - shared KV utilities)
- `package.json` (add @vercel/kv if needed)
- `test-local-api.js` (remove demo-specific assertions) 