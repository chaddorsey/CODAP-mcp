# 21-2 Implement Capability Registration at Session Creation

[Back to task list](./tasks.md)

## Description
Extend the plugin and server to support capability registration when creating a session, allowing the plugin to specify its supported tool sets (e.g., CODAP, SageModeler). This enables dynamic filtering of available tools per session.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-04 23:30:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-01-04 23:45:00 | Status Update | Proposed | InProgress | Started implementation | AI_Agent |
| 2025-01-05 00:30:00 | Status Update | InProgress | Done | Capability-based tool filtering implemented and tested | AI_Agent |

## Requirements
- Update the plugin to send a list of capabilities when creating a session
- Update the server to accept and store session capabilities
- Define and document the capability format (e.g., array of strings)
- Ensure backward compatibility for sessions without explicit capabilities
- Add tests to verify capability registration and storage

## Implementation Plan
1. Update the plugin session creation logic to include capabilities
2. Update the server session creation endpoint to accept and store capabilities
3. Define and document the capability format and validation
4. Ensure backward compatibility for legacy sessions
5. Add or update tests for capability registration
6. Document the new capability registration process

## Verification
- Plugin sends capabilities at session creation
- Server stores and validates session capabilities
- Tests pass for sessions with and without capabilities
- Documentation is updated

## Files Modified
- `src/services/SessionService.ts` (plugin session logic) ✅
- `api/sessions.js` (server session endpoint) ✅
- `api/mcp.js` (MCP protocol handler for capability-based filtering) ✅
- `src/components/AppDualMode.tsx` (dual-mode capability registration) ✅
- `src/components/App.tsx` (CODAP-only mode capability registration) ✅
- `src/components/PairingBanner.tsx` (session creation with capabilities) ✅
- `src/components/ClaudeConnectionPanel.tsx` (session clearing on mode switch) ✅

## Clarification: Capability Registration and Filtering Flow

To fully support and test server-side capability-based tool filtering, the following clarifications and extensions are added to this task:

### Plugin Capability Registration
- The plugin will send its supported capabilities to the server when creating a session (e.g., `["CODAP"]` or `["CODAP", "SAGEMODELER"]`).
- The session creation API (`POST /api/sessions`) will accept a `capabilities` array in the request body and store it in the session object.
- If not provided, the server will default to `["CODAP"]` for backward compatibility.

### Server-Side Filtering
- The server will filter tool lists and metadata responses based on the session's registered capabilities.
- Endpoints such as `/api/metadata` and `/api/tool-registry` will only return tools matching the session's capabilities.

### (Potential Future) Capability Update
- A `PATCH /api/sessions/:code` endpoint for mid-session capability changes is a potential future consideration, but is not being implemented at this time due to MCP communication standards.

### Testing
- The plugin will be updated to create sessions with the correct capabilities based on mode.
- E2E tests will verify that the server returns the correct filtered tool list for each capability set.

These clarifications ensure that the plugin and server are fully aligned for capability-based tool registry filtering and that the implementation is testable end-to-end. 